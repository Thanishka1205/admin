<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Candidate Video</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        #remote-video { width: 640px; height: auto; border: 2px solid #000; }
        .loading { display: none; color: #666; }
        .error { color: red; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Monitor Candidate: {{ candidate.full_name }}</h1>
        <p>Email: {{ candidate.email }}</p>
        <p>Candidate ID: {{ candidate.id }}</p>
        <div class="mt-4">
            <p id="loading" class="loading">Connecting to video stream...</p>
            <p id="error" class="error" style="display: none;"></p>
            <video id="remote-video" autoplay playsinline></video>
        </div>
        <a href="{{ url_for('monitor_test') }}" class="mt-4 inline-block bg-blue-500 text-white px-4 py-2 rounded">Back to Monitor Test</a>
    </div>
    <script>
        const socket = io('http://localhost:5001'); // Admin app's SocketIO server
        const candidateId = {{ candidate.id | tojson }};
        let peerConnection = null;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
                // Add TURN server if needed: { urls: 'turn:your-turn-server.com:3478', username: 'user', credential: 'pass' }
            ]
        };

        socket.on('connect', () => {
            console.log('Admin connected to SocketIO server');
            document.getElementById('loading').style.display = 'block';
            socket.emit('admin_connected', { candidate_id: candidateId });
        });

        socket.on('offer', data => {
            if (data.candidate_id === candidateId) {
                peerConnection = new RTCPeerConnection(configuration);
                peerConnection.ontrack = event => {
                    const remoteVideo = document.getElementById('remote-video');
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        document.getElementById('loading').style.display = 'none';
                        console.log('Received remote stream');
                    }
                };
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice_candidate', {
                            candidate_id: candidateId,
                            candidate: event.candidate
                        });
                    }
                };
                peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        socket.emit('answer', {
                            candidate_id: candidateId,
                            answer: peerConnection.localDescription
                        });
                    })
                    .catch(err => {
                        console.error('Error handling offer:', err);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'Failed to connect to video stream.';
                    });
            }
        });

        socket.on('ice_candidate', data => {
            if (data.candidate_id === candidateId && peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
                    .catch(err => console.error('Error adding ICE candidate:', err));
            }
        });

        socket.on('test_completed', data => {
            if (data.candidate_id === candidateId && peerConnection) {
                peerConnection.close();
                peerConnection = null;
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('loading').style.display = 'none';
                alert('Candidate has completed the test.');
            }
        });

        socket.on('connect_error', err => {
            console.error('SocketIO connection error:', err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'Failed to connect to signaling server.';
        });
    </script>
</body>
</html>